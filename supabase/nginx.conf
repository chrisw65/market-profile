worker_processes auto;

events {
  worker_connections 1024;
}

http {
  map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
  }
  map $http_origin $cors_origin {
    "" "*";
    default $http_origin;
  }

  server {
    listen 8000;
    server_name _;
    client_max_body_size 50m;

    location /auth/ {
      rewrite ^/auth/v1/?(.*)$ /$1 break;
      proxy_pass http://auth:9999;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,apikey,X-Client-Info,X-Supabase-Client,X-Supabase-Api-Version" always;
      add_header Access-Control-Allow-Credentials "true" always;

      if ($request_method = OPTIONS) {
        add_header Access-Control-Max-Age 86400 always;
        return 204;
      }
    }

    location /rest/ {
      rewrite ^/rest/v1/?(.*)$ /$1 break;
      proxy_pass http://rest:3000;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,apikey,X-Client-Info,X-Supabase-Client,X-Supabase-Api-Version" always;
      add_header Access-Control-Allow-Credentials "true" always;
    }

    location /realtime/ {
      rewrite ^/realtime/v1/?(.*)$ /socket$1 break;
      proxy_pass http://realtime:4000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}
